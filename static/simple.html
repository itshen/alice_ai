<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alice - ç®€åŒ–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .message-enter {
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .typing-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin: 8px 0;
            overflow-x: auto;
        }
        
        .tool-call {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .hidden { display: none; }
        .active-tab { background-color: #dbeafe; color: #2563eb; border-bottom: 2px solid #2563eb; }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex h-screen">
        <!-- ä¾§è¾¹æ  -->
        <div class="w-80 bg-white shadow-lg flex flex-col">
            <!-- å¤´éƒ¨ -->
            <div class="p-4 border-b border-gray-200">
                <h1 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-robot mr-2 text-blue-600"></i>
                    Alice
                </h1>
                <p class="text-sm text-gray-600 mt-1">æ™ºèƒ½å·¥å…·è°ƒç”¨æ¡†æ¶</p>
            </div>
            
            <!-- æ ‡ç­¾é¡µ -->
            <div class="flex border-b border-gray-200">
                <button onclick="switchTab('sessions')" id="tab-sessions" class="flex-1 px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 active-tab">
                    <i class="fas fa-comments mr-1"></i>ä¼šè¯
                </button>
                <button onclick="switchTab('tools')" id="tab-tools" class="flex-1 px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800">
                    <i class="fas fa-tools mr-1"></i>å·¥å…·
                </button>
                <button onclick="switchTab('models')" id="tab-models" class="flex-1 px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800">
                    <i class="fas fa-brain mr-1"></i>æ¨¡å‹
                </button>
            </div>
            
            <!-- ä¼šè¯åˆ—è¡¨ -->
            <div id="sessions-panel" class="flex-1 overflow-y-auto custom-scrollbar">
                <div class="p-4">
                    <button onclick="createNewSession()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors mb-4">
                        <i class="fas fa-plus mr-2"></i>æ–°å»ºä¼šè¯
                    </button>
                    
                    <div id="sessions-list" class="space-y-2">
                        <!-- ä¼šè¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- å·¥å…·ç®¡ç† -->
            <div id="tools-panel" class="flex-1 overflow-y-auto custom-scrollbar hidden">
                <div class="p-4">
                    <div class="mb-4">
                        <h3 class="font-medium text-gray-800 mb-2">å·¥å…·æ¨¡å—</h3>
                        <div id="tool-modules-list" class="space-y-2">
                            <!-- å·¥å…·æ¨¡å—åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-medium text-gray-800 mb-2">å¯ç”¨å·¥å…·</h3>
                        <div id="available-tools-list" class="space-y-1">
                            <!-- å¯ç”¨å·¥å…·åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ¨¡å‹ç®¡ç† -->
            <div id="models-panel" class="flex-1 overflow-y-auto custom-scrollbar hidden">
                <div class="p-4">
                    <div class="mb-4">
                        <h3 class="font-medium text-gray-800 mb-2">å½“å‰æ¨¡å‹</h3>
                        <div id="current-model-info" class="p-3 bg-blue-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-brain text-blue-600 mr-2"></i>
                                <span class="font-medium" id="current-provider">åŠ è½½ä¸­...</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1" id="current-model">åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-medium text-gray-800 mb-2">å¯ç”¨æ¨¡å‹</h3>
                        <div id="available-models-list" class="space-y-2">
                            <!-- å¯ç”¨æ¨¡å‹åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¸»èŠå¤©åŒºåŸŸ -->
        <div class="flex-1 flex flex-col">
            <!-- èŠå¤©å¤´éƒ¨ -->
            <div class="bg-white border-b border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="font-semibold text-gray-800" id="session-title">é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªä¼šè¯å¼€å§‹ä¸Aliceå¯¹è¯</h2>
                        <p class="text-sm text-gray-600">
                            <span id="header-provider">-</span> - <span id="header-model">-</span>
                        </p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="clearChat()" class="px-3 py-1 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded hover:bg-gray-50">
                            <i class="fas fa-broom mr-1"></i>æ¸…ç©º
                        </button>
                        <button onclick="exportChat()" class="px-3 py-1 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded hover:bg-gray-50">
                            <i class="fas fa-download mr-1"></i>å¯¼å‡º
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æ¶ˆæ¯åŒºåŸŸ -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4" id="messages-container">
                <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="bg-white border-t border-gray-200 p-4">
                <div class="flex items-end space-x-4">
                    <div class="flex-1">
                        <textarea id="message-input" 
                                  placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯... (Shift+Enteræ¢è¡Œï¼ŒEnterå‘é€)"
                                  class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  rows="3"></textarea>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button onclick="sendMessage()" id="send-button"
                                class="px-6 py-3 text-white rounded-lg transition-colors bg-blue-600 hover:bg-blue-700">
                            <i class="fas fa-paper-plane mr-2"></i>å‘é€
                        </button>
                        <button onclick="toggleStream()" id="stream-button"
                                class="px-4 py-2 text-white text-sm rounded-lg hover:opacity-90 transition-opacity bg-green-600">
                            <i class="fas fa-stream mr-1"></i>
                            <span>æµå¼</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let state = {
            activeTab: 'sessions',
            currentSessionId: null,
            currentSessionTitle: '',
            messages: [],
            sessions: [],
            toolModules: [],
            availableTools: [],
            availableModels: {},
            currentModel: { provider: '', model: '' },
            isLoading: false,
            streamMode: true
        };

        // APIè°ƒç”¨å‡½æ•°
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`http://localhost:8000${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                showNotification('APIè°ƒç”¨å¤±è´¥: ' + error.message, 'error');
                throw error;
            }
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            state.activeTab = tabName;
            
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®æ ·å¼
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('active-tab');
                tab.classList.add('text-gray-600', 'hover:text-gray-800');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active-tab');
            
            // æ˜¾ç¤º/éšè—é¢æ¿
            document.querySelectorAll('[id$="-panel"]').forEach(panel => {
                panel.classList.add('hidden');
            });
            document.getElementById(`${tabName}-panel`).classList.remove('hidden');
        }

        // ä¼šè¯ç®¡ç†
        async function loadSessions() {
            try {
                const response = await apiCall('/sessions');
                state.sessions = response.sessions || [];
                renderSessions();
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
            }
        }

        function renderSessions() {
            const container = document.getElementById('sessions-list');
            container.innerHTML = '';
            
            state.sessions.forEach(session => {
                const sessionElement = document.createElement('div');
                sessionElement.className = `p-3 border border-gray-200 rounded-lg cursor-pointer transition-colors ${
                    state.currentSessionId === session.id ? 'bg-blue-50 border-blue-200' : 'hover:bg-gray-50'
                }`;
                sessionElement.onclick = () => loadSession(session.id);
                
                sessionElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-gray-800 truncate">${session.title}</h3>
                            <p class="text-xs text-gray-500 mt-1">${formatDate(session.updated_at || session.created_at)}</p>
                        </div>
                        <button onclick="event.stopPropagation(); deleteSession('${session.id}')" 
                                class="text-gray-400 hover:text-red-500 ml-2">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(sessionElement);
            });
        }

        async function createNewSession() {
            const title = prompt('è¯·è¾“å…¥ä¼šè¯æ ‡é¢˜:', 'æ–°å¯¹è¯');
            if (!title) return;
            
            try {
                const response = await apiCall('/sessions', {
                    method: 'POST',
                    body: JSON.stringify({ title })
                });
                
                await loadSessions();
                await loadSession(response.session_id);
                showNotification('ä¼šè¯åˆ›å»ºæˆåŠŸ', 'success');
            } catch (error) {
                console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', error);
            }
        }

        async function loadSession(sessionId) {
            try {
                const response = await apiCall(`/sessions/${sessionId}`);
                state.currentSessionId = sessionId;
                state.messages = response.messages || [];
                
                const session = state.sessions.find(s => s.id === sessionId);
                state.currentSessionTitle = session ? session.title : 'æœªçŸ¥ä¼šè¯';
                
                document.getElementById('session-title').textContent = state.currentSessionTitle;
                renderMessages();
                renderSessions(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
                
                setTimeout(scrollToBottom, 100);
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
            }
        }

        async function deleteSession(sessionId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿ')) return;
            
            try {
                await apiCall(`/sessions/${sessionId}`, { method: 'DELETE' });
                await loadSessions();
                
                if (state.currentSessionId === sessionId) {
                    state.currentSessionId = null;
                    state.currentSessionTitle = '';
                    state.messages = [];
                    document.getElementById('session-title').textContent = 'é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªä¼šè¯';
                    renderMessages();
                }
                
                showNotification('ä¼šè¯åˆ é™¤æˆåŠŸ', 'success');
            } catch (error) {
                console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', error);
            }
        }

        // æ¶ˆæ¯å¤„ç†
        function getMessageContainerClass(message) {
            if (message.role === 'user') {
                return 'bg-blue-600 text-white';
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å·¥å…·è°ƒç”¨ç»“æœ
            // æ”¯æŒä¸¤ç§æ ¼å¼ï¼šæ¢è¡Œåˆ†éš”å’Œç©ºæ ¼åˆ†éš”
            const toolCallPattern1 = /^å‡½æ•°å:\s*(.+?)\nå‚æ•°:\s*(.+?)\næ‰§è¡Œæ—¶é—´:\s*(.+?)(?:\n|$)/;
            const toolCallPattern2 = /^å‡½æ•°å:\s*(.+?)\s+å‚æ•°:\s*(.+?)\s+æ‰§è¡Œæ—¶é—´:\s*(.+?)(?:\n|$)/;
            
            if (toolCallPattern1.test(message.content) || toolCallPattern2.test(message.content)) {
                return 'bg-transparent border-0'; // é€æ˜èƒŒæ™¯ï¼Œè®©å†…éƒ¨çš„ç´«è‰²æ ·å¼æ˜¾ç¤º
            }
            
            return 'bg-white border border-gray-200';
        }

        function renderMessages() {
            const container = document.getElementById('messages-container');
            container.innerHTML = '';
            
            state.messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `message-enter ${
                    message.role === 'user' ? 'flex justify-end' : 'flex justify-start'
                }`;
                
                messageElement.innerHTML = `
                    <div class="max-w-3xl rounded-lg p-4 shadow-sm ${getMessageContainerClass(message)}">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${
                                message.role === 'user' ? 'bg-blue-500' : 'bg-gray-100'
                            }">
                                <i class="text-sm ${
                                    message.role === 'user' ? 'fas fa-user text-white' : 'fas fa-robot text-gray-600'
                                }"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="text-sm font-medium">${
                                        message.role === 'user' ? 'ä½ ' : 'Alice '
                                    }</span>
                                    <span class="text-xs opacity-75">${formatTime(message.timestamp)}</span>
                                </div>
                                <div class="prose prose-sm max-w-none">${formatMessage(message.content)}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(messageElement);
            });
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message || state.isLoading) return;
            
            input.value = '';
            state.isLoading = true;
            updateSendButton();
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            state.messages.push({
                id: Date.now(),
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });
            
            renderMessages();
            scrollToBottom();
            
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            showLoadingIndicator();
            
            try {
                if (state.streamMode) {
                    await sendStreamMessage(message);
                } else {
                    await sendNormalMessage(message);
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                showNotification('å‘é€æ¶ˆæ¯å¤±è´¥: ' + error.message, 'error');
            } finally {
                state.isLoading = false;
                updateSendButton();
                hideLoadingIndicator();
            }
        }

        async function sendStreamMessage(message) {
            try {
                const response = await fetch('http://localhost:8000/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: state.currentSessionId,
                        stream: true
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                // åˆ›å»ºAIæ¶ˆæ¯
                const aiMessage = {
                    id: Date.now() + 1,
                    role: 'assistant',
                    content: '',
                    timestamp: new Date().toISOString()
                };
                state.messages.push(aiMessage);
                
                let buffer = '';
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    aiMessage.content = buffer;
                    renderMessages();
                    scrollToBottom();
                }
                
                // é‡æ–°åŠ è½½ä¼šè¯ä»¥è·å–å®Œæ•´å†å²
                if (state.currentSessionId) {
                    await loadSession(state.currentSessionId);
                }
                
            } catch (error) {
                throw error;
            }
        }

        async function sendNormalMessage(message) {
            try {
                const response = await apiCall('/chat', {
                    method: 'POST',
                    body: JSON.stringify({
                        message: message,
                        session_id: state.currentSessionId,
                        stream: false
                    })
                });
                
                // æ·»åŠ AIå›å¤
                state.messages.push({
                    id: Date.now() + 1,
                    role: 'assistant',
                    content: response.message,
                    timestamp: new Date().toISOString()
                });
                
                renderMessages();
                scrollToBottom();
                
                // é‡æ–°åŠ è½½ä¼šè¯ä»¥è·å–å®Œæ•´å†å²
                if (state.currentSessionId) {
                    await loadSession(state.currentSessionId);
                }
                
            } catch (error) {
                throw error;
            }
        }

        // å·¥å…·ç®¡ç†
        async function loadToolModules() {
            try {
                const response = await apiCall('/tool-modules');
                state.toolModules = response.modules || [];
                renderToolModules();
            } catch (error) {
                console.error('åŠ è½½å·¥å…·æ¨¡å—å¤±è´¥:', error);
            }
        }

        async function loadAvailableTools() {
            try {
                const response = await apiCall('/tools');
                state.availableTools = response.tools || [];
                renderAvailableTools();
            } catch (error) {
                console.error('åŠ è½½å·¥å…·å¤±è´¥:', error);
            }
        }

        function renderToolModules() {
            const container = document.getElementById('tool-modules-list');
            container.innerHTML = '';
            
            state.toolModules.forEach(module => {
                const moduleElement = document.createElement('div');
                moduleElement.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
                
                moduleElement.innerHTML = `
                    <div class="flex-1">
                        <span class="text-sm font-medium">${module.name}</span>
                        <p class="text-xs text-gray-600">${module.description}</p>
                    </div>
                    <button onclick="toggleModule('${module.name}')"
                            class="w-8 h-4 rounded-full relative transition-colors ${
                                module.is_loaded ? 'bg-green-500' : 'bg-gray-400'
                            }">
                        <div class="w-4 h-4 bg-white rounded-full shadow transform transition-transform ${
                            module.is_loaded ? 'translate-x-4' : 'translate-x-0'
                        }"></div>
                    </button>
                `;
                
                container.appendChild(moduleElement);
            });
        }

        function renderAvailableTools() {
            const container = document.getElementById('available-tools-list');
            container.innerHTML = '';
            
            state.availableTools.forEach(tool => {
                const toolElement = document.createElement('div');
                toolElement.className = 'p-2 bg-gray-50 rounded text-sm';
                
                toolElement.innerHTML = `
                    <span class="font-medium">${tool.name}</span>
                    <p class="text-xs text-gray-600 mt-1">${tool.description}</p>
                `;
                
                container.appendChild(toolElement);
            });
        }

        async function toggleModule(moduleName) {
            const module = state.toolModules.find(m => m.name === moduleName);
            if (!module) return;
            
            try {
                if (module.is_loaded) {
                    await apiCall('/tool-modules/unload', {
                        method: 'POST',
                        body: JSON.stringify({ module: moduleName })
                    });
                } else {
                    await apiCall('/tool-modules/load', {
                        method: 'POST',
                        body: JSON.stringify({ modules: [moduleName] })
                    });
                }
                
                await loadToolModules();
                await loadAvailableTools();
                showNotification(`æ¨¡å— ${moduleName} ${module.is_loaded ? 'å¸è½½' : 'åŠ è½½'}æˆåŠŸ`, 'success');
            } catch (error) {
                console.error('åˆ‡æ¢æ¨¡å—å¤±è´¥:', error);
            }
        }

        // æ¨¡å‹ç®¡ç†
        async function loadModels() {
            try {
                const response = await apiCall('/models');
                if (response.success && response.data && response.data.provider_details) {
                    state.availableModels = response.data.provider_details;
                } else {
                    state.availableModels = {};
                }
                renderAvailableModels();
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', error);
                state.availableModels = {};
            }
        }

        async function loadCurrentModel() {
            try {
                const response = await apiCall('/models/current');
                if (response.success && response.data) {
                    state.currentModel = response.data;
                } else {
                    state.currentModel = { provider: '', model: '' };
                }
                updateCurrentModelDisplay();
            } catch (error) {
                console.error('åŠ è½½å½“å‰æ¨¡å‹å¤±è´¥:', error);
                state.currentModel = { provider: '', model: '' };
            }
        }

        function updateCurrentModelDisplay() {
            document.getElementById('current-provider').textContent = state.currentModel.provider;
            document.getElementById('current-model').textContent = state.currentModel.model;
            document.getElementById('header-provider').textContent = state.currentModel.provider;
            document.getElementById('header-model').textContent = state.currentModel.model;
        }

        function renderAvailableModels() {
            const container = document.getElementById('available-models-list');
            container.innerHTML = '';
            
            Object.entries(state.availableModels).forEach(([provider, model]) => {
                const modelElement = document.createElement('div');
                modelElement.className = 'p-3 border border-gray-200 rounded-lg';
                
                modelElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-medium">${provider}</span>
                            <p class="text-sm text-gray-600">${model.model}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs ${model.enabled ? 'text-green-600' : 'text-gray-400'}">
                                <i class="${model.enabled ? 'fas fa-check-circle' : 'fas fa-times-circle'}"></i>
                            </span>
                            <button onclick="switchModel('${provider}')"
                                    ${!model.enabled ? 'disabled' : ''}
                                    class="px-2 py-1 text-xs text-white rounded ${
                                        model.enabled ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 cursor-not-allowed'
                                    }">
                                åˆ‡æ¢
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(modelElement);
            });
        }

        async function switchModel(provider) {
            try {
                const response = await apiCall('/models/switch', {
                    method: 'POST',
                    body: JSON.stringify({ provider })
                });
                
                if (response.success) {
                    await loadCurrentModel();
                    showNotification(response.message || `å·²åˆ‡æ¢åˆ°æ¨¡å‹: ${provider}`, 'success');
                } else {
                    showNotification('åˆ‡æ¢æ¨¡å‹å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ‡æ¢æ¨¡å‹å¤±è´¥:', error);
                showNotification('åˆ‡æ¢æ¨¡å‹å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å·¥å…·å‡½æ•°
        function handleEnterKey(event) {
            if (event.shiftKey) {
                return;
            } else {
                event.preventDefault();
                sendMessage();
            }
        }

        function toggleStream() {
            state.streamMode = !state.streamMode;
            const button = document.getElementById('stream-button');
            const icon = button.querySelector('i');
            const text = button.querySelector('span');
            
            if (state.streamMode) {
                button.className = 'px-4 py-2 text-white text-sm rounded-lg hover:opacity-90 transition-opacity bg-green-600';
                icon.className = 'fas fa-stream mr-1';
                text.textContent = 'æµå¼';
            } else {
                button.className = 'px-4 py-2 text-white text-sm rounded-lg hover:opacity-90 transition-opacity bg-gray-600';
                icon.className = 'fas fa-stop mr-1';
                text.textContent = 'æ™®é€š';
            }
        }

        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) {
                state.messages = [];
                renderMessages();
            }
        }

        function exportChat() {
            const chatData = {
                session_id: state.currentSessionId,
                title: state.currentSessionTitle,
                messages: state.messages,
                exported_at: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(chatData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_${state.currentSessionId || 'export'}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        function formatTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        function formatMessage(content) {
            if (!content) return '';
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å·¥å…·è°ƒç”¨ç»“æœï¼ˆä»¥"å‡½æ•°å:"å¼€å¤´ï¼‰
            // æ”¯æŒä¸¤ç§æ ¼å¼ï¼šæ¢è¡Œåˆ†éš”å’Œç©ºæ ¼åˆ†éš”
            const toolCallPattern1 = /^å‡½æ•°å:\s*(.+?)\nå‚æ•°:\s*(.+?)\næ‰§è¡Œæ—¶é—´:\s*(.+?)(?:\n|$)/;
            const toolCallPattern2 = /^å‡½æ•°å:\s*(.+?)\s+å‚æ•°:\s*(.+?)\s+æ‰§è¡Œæ—¶é—´:\s*(.+?)(?:\n|$)/;
            
            let match = content.match(toolCallPattern1) || content.match(toolCallPattern2);
            
            if (match) {
                const functionName = escapeHtml(match[1].trim());
                const parameters = escapeHtml(match[2].trim());
                const executionTime = escapeHtml(match[3].trim());
                
                // è·å–å‰©ä½™å†…å®¹ï¼ˆå·¥å…·æ‰§è¡Œç»“æœï¼‰
                const remainingContent = content.replace(match[0], '').trim();
                
                return `
                    <div class="tool-execution-header bg-gradient-to-r from-purple-500 to-indigo-600 text-white p-3 rounded-lg mb-3">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-cog mr-2"></i>
                            <span class="font-semibold">å·¥å…·æ‰§è¡Œ</span>
                        </div>
                        <div class="text-sm space-y-1">
                            <div><span class="opacity-90">å‡½æ•°:</span> <code class="bg-white bg-opacity-20 px-1 rounded">${functionName}</code></div>
                            <div><span class="opacity-90">å‚æ•°:</span> <code class="bg-white bg-opacity-20 px-1 rounded">${parameters}</code></div>
                            <div><span class="opacity-90">è€—æ—¶:</span> <span class="text-green-200">${executionTime}</span></div>
                        </div>
                    </div>
                    ${remainingContent ? '<div class="tool-result">' + formatRegularContent(remainingContent) + '</div>' : ''}
                `;
            }
            
            return formatRegularContent(content);
        }

        function formatRegularContent(content) {
            if (!content) return '';
            
            // å…ˆè½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
            content = escapeHtml(content);
            
            content = content.replace(/```(\w+)?\n([\s\S]*?)```/g, '<div class="code-block"><pre><code>$2</code></pre></div>');
            content = content.replace(/`([^`]+)`/g, '<code class="bg-gray-100 px-1 py-0.5 rounded text-sm">$1</code>');
            content = content.replace(/\[å·¥å…·è°ƒç”¨: ([^\]]+)\]/g, '<div class="tool-call"><i class="fas fa-tools mr-2"></i>å·¥å…·è°ƒç”¨: $1</div>');
            content = content.replace(/\n/g, '<br>');
            content = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-600 hover:underline">$1</a>');
            
            return content;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showLoadingIndicator() {
            const container = document.getElementById('messages-container');
            const loadingElement = document.createElement('div');
            loadingElement.id = 'loading-indicator';
            loadingElement.className = 'flex justify-start';
            
            loadingElement.innerHTML = `
                <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-robot text-gray-600 text-sm"></i>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="typing-indicator"></div>
                            <span class="text-sm text-gray-600">AIæ­£åœ¨æ€è€ƒ...</span>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(loadingElement);
            scrollToBottom();
        }

        function hideLoadingIndicator() {
            const loadingElement = document.getElementById('loading-indicator');
            if (loadingElement) {
                loadingElement.remove();
            }
        }

        function updateSendButton() {
            const button = document.getElementById('send-button');
            const input = document.getElementById('message-input');
            
            if (state.isLoading || !input.value.trim()) {
                button.className = 'px-6 py-3 text-white rounded-lg transition-colors bg-gray-400 cursor-not-allowed';
                button.disabled = true;
            } else {
                button.className = 'px-6 py-3 text-white rounded-lg transition-colors bg-blue-600 hover:bg-blue-700';
                button.disabled = false;
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('message-input').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                handleEnterKey(event);
            }
        });

        document.getElementById('message-input').addEventListener('input', function() {
            updateSendButton();
        });

        // åˆå§‹åŒ–
        async function init() {
            console.log('ğŸš€ åˆå§‹åŒ– Alice å‰ç«¯...');
            
            try {
                await loadSessions();
                await loadToolModules();
                await loadAvailableTools();
                await loadModels();
                await loadCurrentModel();
                
                // å¦‚æœæœ‰ä¼šè¯ï¼ŒåŠ è½½æœ€è¿‘çš„ä¸€ä¸ª
                if (state.sessions.length > 0) {
                    await loadSession(state.sessions[0].id);
                }
                
                console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                showNotification('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥', 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html> 